
## この文書について

この文書は、Embulkのマネージドサービスtroccoをつかってみたと体験記です。

## 対象読者

* これからデータ基盤を作る予定だが、サーバの管理とかの経験がなくマネージドサービスを検討しているかた
* troccoに興味のあるかた
* Embulkを使ったことある人

なるべくこの資料をみると「troccoのイメージが掴めた」と思えるような文書にしたいと思っています。

## そもそものきっかけ

私は、Embulkがリリースされた2015年1月から、Embulkのまとめを作ってその動向をみてきました。そういう中でプライムナンバーの小林様と知り合いました。Embulkのマネージドサービスということで、troccoには前々から興味があったのですが、小林様の好意でtroccoを使わせていただくことができました。

## troccoとは

Embulk + αのマネージドサービスが利用できるプライムナンバー社のサービスです。

## Embulkとは

2015年にfluendやなどのサービスを開発したトレジャーデータ社の古橋さんが開発したオープンソースソフトウェアです。

## troccoでデータを登録するまでのステップ

* 連携サービスのアカウント作成: ex) Google Bigqueryのアカウントを取得
  * BigQueryにはサンドボックスという無料で利用できるサービスがありますが、このサービスをtroccoで利用酢rとエラーになってしまうようです。(これはbigqueryのプラグインの問題です。)
* [無料トライアル](https://trocco.io/inquiry_trial/new)を申し込み

## troccoのアカウントができたら

* 連携サービスの認証情報の登録
* 転送ジョブの登録

## troccoの申し込み

## 実際のデータ投入

#### 転送元・転送先の設定

自分のデスクトップにあるファイルを、Bigqueryにアップロードするのをやってみます。サンプルに利用するファイルはEmbulkで例として使っているcsvファイルを利用します。このファイルはembulk exampleコマンドで生成することができます。またこちらでも同じファイルをダウンロードすることができますので、デスクトップに保存をしてください。

* 出力元: LocalFileを選択します。
* 出力先: bigqueryを選択します。
* 「この内容で作成」を押し具体的な設定を行います。

### 概要設定

* 概要設定
  * 名前: この転送の名前を指定します。
  * メモ: この転送の説明を記述することができます。
  * 共有するグループ: グループを使っているとこの転送情報を
* 転送元ローカルアップロードの設定
  * ファイル: アップロードするファイルを指定します。
  * 入力ファイル形式: `CSV`, `JSON`などから
  * ファイル名には変数を利用することができるようです。日時で生成される売り上げファイルなどはこちらの変数を使うことがdけいるようです(これは後日使ってみたいと思います。)
* Bigqueryの接続設定
  * Bigqueryの接続情報: 事前に作成した接続情報が一覧表示されるので、利用する接続設定を選択します。
  * データセット: [BigQuery](https://cloud.google.com/bigquery/docs/datasets-intro?hl=ja)で指定するデータセットの名前を指定します。選択した接続情報で利用可能なデータセットが一覧表示されます。まだBigQueryにデータセットがない場合は、作成したいデータセットの名前を入力します。
  * テーブル: アップロードするデータを登録するテーブル名を指定します。このテーブルも既存のテーブルは一覧表示されて選択をすることができます。データ登録時にテーブルを一緒に作成する場合は、作成するテーブル名を入力します。
  * データセットのリージョン: テーブルを登録する先のリージョンを指定します。
  * データセットの自動作成オプション: データセットが未作成の場合は、datasetを自動で作成するを選択します。
  * 転送モード: データを追加登録する場合は、append、既存のデータを入れ替えする場合: replaceを選択します
* 保存して自動設定・プレビューへボタンを押します。

### データプレビュー・詳細設定

* 前画面で指定したファイルの中身を類推して、カラム情報を自動作成します。(embulk guessを実行します。)
  * 実行した結果はマネージドサービスらしく、Webインタフェースでみやすくなっています。
* カラム定義
  * もし自動類推されたカラム情報が期待するカラムと異なる場合、カラムの情報を指定します。
  * カラム名: 指定したカラム名がBigQueryに登録した際のカラム名になります。
  * 元カラム名: csvファイルの先頭行に記載されてるカラム名が表示されます。
  * データ型: 利用するデータ型を一覧から選択します
  * 日付フォーマット: 入力データが例えば2020年8月30日 14時3分05秒で、2020-08-30 14:03:05のようになっている場合、`%Y-%m-%d %H:%M:%S`のように記述します。
  * カラム追加:
* フィルター設定
